---
title: "Widget æ ¸å¿ƒç»„ä»¶"
epic: "frontend-widget-architecture"
number: 4
batch: 2
status: "pending"
priority: "high"
estimated_hours: 12
tags: ["widget", "components", "bridge", "theme"]
parallel: false
depends_on: [1, 2, 3]
assigned_to: ""
reviewer: ""
created_at: "2025-10-07T05:19:46Z"
updated_at: "2025-10-07T05:19:46Z"
---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç° Widget å®¹å™¨ã€æ¡¥æ¥é€šä¿¡ã€ä¸»é¢˜ç³»ç»Ÿç­‰æ ¸å¿ƒç»„ä»¶ï¼Œå»ºç«‹ Widget ä¸å®¿ä¸» CRM é¡µé¢çš„å®‰å…¨é€šä¿¡æœºåˆ¶å’Œå¯é…ç½®çš„è§†è§‰æ ·å¼ç³»ç»Ÿã€‚

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### æ ¸å¿ƒè¦æ±‚
- [ ] Widget å®¹å™¨ç»„ä»¶æ”¯æŒæµ®åŠ¨å’ŒåµŒå…¥å¼ä¸¤ç§æ¨¡å¼
- [ ] å®ç°å®‰å…¨çš„ postMessage é€šä¿¡æ¡¥æ¥æœºåˆ¶
- [ ] ä¸»é¢˜ç³»ç»Ÿæ”¯æŒåŠ¨æ€åˆ‡æ¢å’Œè‡ªå®šä¹‰é…ç½®
- [ ] å“åº”å¼è®¾è®¡é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- [ ] å®Œæ•´çš„é”™è¯¯è¾¹ç•Œå’Œé™çº§å¤„ç†

### æŠ€æœ¯æ ‡å‡†
- [ ] ç»„ä»¶ API è®¾è®¡æ¸…æ™°ï¼Œprops ç±»å‹å®‰å…¨
- [ ] é€šä¿¡æœºåˆ¶ç»è¿‡å®‰å…¨éªŒè¯ï¼Œé˜²æ­¢ XSS æ”»å‡»
- [ ] ä¸»é¢˜é…ç½®æ”¯æŒå®æ—¶åˆ‡æ¢ï¼Œæ— éœ€é‡è½½
- [ ] ç»„ä»¶è§£è€¦è‰¯å¥½ï¼Œæ”¯æŒç‹¬ç«‹æµ‹è¯•

## ğŸ“ è¯¦ç»†ä»»åŠ¡

### 4.1 Widget å®¹å™¨ç»„ä»¶ (4å°æ—¶)
- åˆ›å»º `WidgetContainer` ç»„ä»¶ï¼Œæ”¯æŒæµ®åŠ¨å’ŒåµŒå…¥ä¸¤ç§æ¨¡å¼
- å®ç°ç»„ä»¶å°ºå¯¸è°ƒæ•´ã€ä½ç½®æ‹–æ‹½ã€æœ€å°åŒ–ç­‰äº¤äº’åŠŸèƒ½
- æ·»åŠ åŠ¨ç”»è¿‡æ¸¡æ•ˆæœå’Œå¾®äº¤äº’
- è®¾è®¡ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶

### 4.2 é€šä¿¡æ¡¥æ¥ç³»ç»Ÿ (4å°æ—¶)
- å®ç° `BridgeService` æœåŠ¡ï¼Œå¤„ç†ä¸å®¿ä¸»é¡µé¢çš„é€šä¿¡
- å»ºç«‹å®‰å…¨çš„ postMessage APIï¼Œæ”¯æŒèº«ä»½éªŒè¯å’Œæ•°æ®ä¼ è¾“
- å®ç°è¯·æ±‚-å“åº”æ¨¡å¼å’Œäº‹ä»¶è®¢é˜…æœºåˆ¶
- æ·»åŠ é€šä¿¡è¶…æ—¶ã€é‡è¯•å’Œé”™è¯¯æ¢å¤ç­–ç•¥

### 4.3 ä¸»é¢˜å’Œæ ·å¼ç³»ç»Ÿ (3å°æ—¶)
- åˆ›å»º `ThemeProvider` å’Œä¸»é¢˜é…ç½®ç³»ç»Ÿ
- å®ç°åŠ¨æ€ä¸»é¢˜åˆ‡æ¢å’Œè‡ªå®šä¹‰æ ·å¼æ³¨å…¥
- æ”¯æŒäº®è‰²/æš—è‰²æ¨¡å¼åˆ‡æ¢
- å»ºç«‹ç»„ä»¶æ ·å¼å˜é‡å’Œè®¾è®¡ä»¤ç‰Œä½“ç³»

### 4.4 é”™è¯¯è¾¹ç•Œå’Œç›‘æ§ (1å°æ—¶)
- å®ç° `ErrorBoundary` ç»„ä»¶ï¼Œæ•è·å’Œæ¸²æŸ“é”™è¯¯çŠ¶æ€
- æ·»åŠ ç»„ä»¶æ€§èƒ½ç›‘æ§å’Œé”™è¯¯æ—¥å¿—æ”¶é›†
- è®¾è®¡ä¼˜é›…çš„é™çº§ç­–ç•¥å’Œç”¨æˆ·æç¤º

## ğŸ”§ æŠ€æœ¯è¦æ±‚

### æ ¸å¿ƒç»„ä»¶ç»“æ„
```typescript
// Widget å®¹å™¨ç»„ä»¶
interface WidgetContainerProps {
  mode: 'floating' | 'embedded';
  position?: Position;
  size?: Size;
  theme?: ThemeConfig;
  bridgeConfig: BridgeConfig;
}

// é€šä¿¡æ¡¥æ¥æœåŠ¡
interface BridgeService {
  init(config: BridgeConfig): Promise<void>;
  sendRequest<T>(request: BridgeRequest): Promise<BridgeResponse<T>>;
  subscribe(event: string, handler: EventHandler): void;
  unsubscribe(event: string, handler: EventHandler): void;
}

// ä¸»é¢˜é…ç½®ç³»ç»Ÿ
interface ThemeConfig {
  mode: 'light' | 'dark' | 'auto';
  primaryColor: string;
  customCSS?: string;
  branding?: BrandingConfig;
}
```

### å®‰å…¨é€šä¿¡åè®®
```typescript
interface BridgeMessage {
  id: string;
  type: 'request' | 'response' | 'event';
  payload: any;
  timestamp: number;
  signature?: string;
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ widget/
â”‚   â”‚   â”œâ”€â”€ WidgetContainer.tsx
â”‚   â”‚   â”œâ”€â”€ WidgetHeader.tsx
â”‚   â”‚   â”œâ”€â”€ WidgetContent.tsx
â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ bridge/
â”‚   â”‚   â”œâ”€â”€ BridgeService.ts
â”‚   â”‚   â”œâ”€â”€ MessageHandler.ts
â”‚   â”‚   â”œâ”€â”€ SecurityValidator.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ theme/
â”‚       â”œâ”€â”€ ThemeProvider.tsx
â”‚       â”œâ”€â”€ ThemeContext.ts
â”‚       â”œâ”€â”€ useTheme.ts
â”‚       â””â”€â”€ index.ts
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ widget.ts
â”‚   â”œâ”€â”€ bridge.ts
â”‚   â””â”€â”€ theme.ts
â””â”€â”€ hooks/
    â”œâ”€â”€ useBridge.ts
    â”œâ”€â”€ useTheme.ts
    â””â”€â”€ useWidget.ts
```

## âœ… æµ‹è¯•è¦æ±‚

- [ ] Widget å®¹å™¨åœ¨ä¸¤ç§æ¨¡å¼ä¸‹æ­£ç¡®æ¸²æŸ“
- [ ] é€šä¿¡æ¡¥æ¥åŠŸèƒ½æ­£å¸¸ï¼Œæ¶ˆæ¯æ”¶å‘æ— è¯¯
- [ ] ä¸»é¢˜åˆ‡æ¢å®æ—¶ç”Ÿæ•ˆï¼Œæ ·å¼æ­£ç¡®åº”ç”¨
- [ ] é”™è¯¯è¾¹ç•Œæ•è·å¼‚å¸¸ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
- [ ] ç»„ä»¶å“åº”å¼è®¾è®¡åœ¨ä¸åŒå±å¹•ä¸‹æ­£å¸¸æ˜¾ç¤º

## ğŸš€ äº¤ä»˜ç‰©

- [ ] Widget å®¹å™¨ç»„ä»¶åŠå­ç»„ä»¶
- [ ] å®Œæ•´çš„é€šä¿¡æ¡¥æ¥æœåŠ¡
- [ ] ä¸»é¢˜ç³»ç»Ÿå’Œè®¾è®¡ä»¤ç‰Œ
- [ ] é”™è¯¯è¾¹ç•Œå’Œç›‘æ§ç»„ä»¶
- [ ] ç»„ä»¶ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç 

## ğŸ“š å‚è€ƒèµ„æ–™

- [React ç»„ä»¶è®¾è®¡æ¨¡å¼](https://reactjs.org/docs/thinking-in-react.html)
- [postMessage API å®‰å…¨æœ€ä½³å®è·µ](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [CSS è‡ªå®šä¹‰å±æ€§å’Œä¸»é¢˜ç³»ç»Ÿ](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties)
- [React é”™è¯¯è¾¹ç•Œ](https://reactjs.org/docs/error-boundaries.html)