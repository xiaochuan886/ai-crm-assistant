---
title: "Widget 核心组件"
epic: "frontend-widget-architecture"
number: 4
batch: 2
status: "pending"
priority: "high"
estimated_hours: 12
tags: ["widget", "components", "bridge", "theme"]
parallel: false
depends_on: [1, 2, 3]
assigned_to: ""
reviewer: ""
created_at: "2025-10-07T05:19:46Z"
updated_at: "2025-10-07T05:19:46Z"
---

## 📋 任务概述

实现 Widget 容器、桥接通信、主题系统等核心组件，建立 Widget 与宿主 CRM 页面的安全通信机制和可配置的视觉样式系统。

## 🎯 验收标准

### 核心要求
- [ ] Widget 容器组件支持浮动和嵌入式两种模式
- [ ] 实现安全的 postMessage 通信桥接机制
- [ ] 主题系统支持动态切换和自定义配置
- [ ] 响应式设计适配不同屏幕尺寸
- [ ] 完整的错误边界和降级处理

### 技术标准
- [ ] 组件 API 设计清晰，props 类型安全
- [ ] 通信机制经过安全验证，防止 XSS 攻击
- [ ] 主题配置支持实时切换，无需重载
- [ ] 组件解耦良好，支持独立测试

## 📝 详细任务

### 4.1 Widget 容器组件 (4小时)
- 创建 `WidgetContainer` 组件，支持浮动和嵌入两种模式
- 实现组件尺寸调整、位置拖拽、最小化等交互功能
- 添加动画过渡效果和微交互
- 设计组件生命周期管理机制

### 4.2 通信桥接系统 (4小时)
- 实现 `BridgeService` 服务，处理与宿主页面的通信
- 建立安全的 postMessage API，支持身份验证和数据传输
- 实现请求-响应模式和事件订阅机制
- 添加通信超时、重试和错误恢复策略

### 4.3 主题和样式系统 (3小时)
- 创建 `ThemeProvider` 和主题配置系统
- 实现动态主题切换和自定义样式注入
- 支持亮色/暗色模式切换
- 建立组件样式变量和设计令牌体系

### 4.4 错误边界和监控 (1小时)
- 实现 `ErrorBoundary` 组件，捕获和渲染错误状态
- 添加组件性能监控和错误日志收集
- 设计优雅的降级策略和用户提示

## 🔧 技术要求

### 核心组件结构
```typescript
// Widget 容器组件
interface WidgetContainerProps {
  mode: 'floating' | 'embedded';
  position?: Position;
  size?: Size;
  theme?: ThemeConfig;
  bridgeConfig: BridgeConfig;
}

// 通信桥接服务
interface BridgeService {
  init(config: BridgeConfig): Promise<void>;
  sendRequest<T>(request: BridgeRequest): Promise<BridgeResponse<T>>;
  subscribe(event: string, handler: EventHandler): void;
  unsubscribe(event: string, handler: EventHandler): void;
}

// 主题配置系统
interface ThemeConfig {
  mode: 'light' | 'dark' | 'auto';
  primaryColor: string;
  customCSS?: string;
  branding?: BrandingConfig;
}
```

### 安全通信协议
```typescript
interface BridgeMessage {
  id: string;
  type: 'request' | 'response' | 'event';
  payload: any;
  timestamp: number;
  signature?: string;
}
```

## 📁 文件结构

```
src/
├── components/
│   ├── widget/
│   │   ├── WidgetContainer.tsx
│   │   ├── WidgetHeader.tsx
│   │   ├── WidgetContent.tsx
│   │   ├── ErrorBoundary.tsx
│   │   └── index.ts
│   ├── bridge/
│   │   ├── BridgeService.ts
│   │   ├── MessageHandler.ts
│   │   ├── SecurityValidator.ts
│   │   └── index.ts
│   └── theme/
│       ├── ThemeProvider.tsx
│       ├── ThemeContext.ts
│       ├── useTheme.ts
│       └── index.ts
├── types/
│   ├── widget.ts
│   ├── bridge.ts
│   └── theme.ts
└── hooks/
    ├── useBridge.ts
    ├── useTheme.ts
    └── useWidget.ts
```

## ✅ 测试要求

- [ ] Widget 容器在两种模式下正确渲染
- [ ] 通信桥接功能正常，消息收发无误
- [ ] 主题切换实时生效，样式正确应用
- [ ] 错误边界捕获异常，显示友好提示
- [ ] 组件响应式设计在不同屏幕下正常显示

## 🚀 交付物

- [ ] Widget 容器组件及子组件
- [ ] 完整的通信桥接服务
- [ ] 主题系统和设计令牌
- [ ] 错误边界和监控组件
- [ ] 组件使用文档和示例代码

## 📚 参考资料

- [React 组件设计模式](https://reactjs.org/docs/thinking-in-react.html)
- [postMessage API 安全最佳实践](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [CSS 自定义属性和主题系统](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties)
- [React 错误边界](https://reactjs.org/docs/error-boundaries.html)