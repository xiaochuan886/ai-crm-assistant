---
title: "çŠ¶æ€ç®¡ç†ç³»ç»Ÿ"
epic: "frontend-widget-architecture"
number: 6
batch: 2
status: "pending"
priority: "high"
estimated_hours: 10
tags: ["state-management", "zustand", "react-query", "persistence"]
parallel: false
depends_on: [1, 2, 3]
assigned_to: ""
reviewer: ""
created_at: "2025-10-07T05:19:46Z"
updated_at: "2025-10-07T05:19:46Z"
---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç° Zustand + React Query çŠ¶æ€ç®¡ç†æ¶æ„ï¼Œå»ºç«‹å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†ã€æ•°æ®è·å–ã€ç¼“å­˜ç­–ç•¥å’ŒæŒä¹…åŒ–å­˜å‚¨çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### æ ¸å¿ƒè¦æ±‚
- [ ] é›†æˆ Zustand å®ç°å…¨å±€çŠ¶æ€ç®¡ç†
- [ ] é…ç½® React Query è¿›è¡ŒæœåŠ¡ç«¯çŠ¶æ€ç®¡ç†å’Œæ•°æ®è·å–
- [ ] å®ç°çŠ¶æ€æŒä¹…åŒ–ç­–ç•¥ï¼ˆlocalStorage/sessionStorageï¼‰
- [ ] å»ºç«‹çŠ¶æ€æ›´æ–°æœºåˆ¶å’Œè®¢é˜…ç³»ç»Ÿ
- [ ] æ”¯æŒçŠ¶æ€è°ƒè¯•å’Œå¼€å‘å·¥å…·é›†æˆ

### æŠ€æœ¯æ ‡å‡†
- [ ] çŠ¶æ€æ›´æ–°æ€§èƒ½ä¼˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- [ ] æ•°æ®ç¼“å­˜ç­–ç•¥åˆç†ï¼Œæ”¯æŒå¤±æ•ˆå’Œé‡æ–°è·å–
- [ ] çŠ¶æ€ç»“æ„è®¾è®¡æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- [ ] ç±»å‹å®‰å…¨ï¼Œå®Œæ•´çš„ TypeScript æ”¯æŒ

## ğŸ“ è¯¦ç»†ä»»åŠ¡

### 6.1 Zustand çŠ¶æ€ç®¡ç†æ¶æ„ (4å°æ—¶)
- è®¾è®¡å’Œå®ç°å…¨å±€çŠ¶æ€ store ç»“æ„
- åˆ›å»ºå¤šä¸ªé¢†åŸŸ storeï¼ˆchatã€widgetã€userã€ui ç­‰ï¼‰
- å®ç° state slices å’Œä¸­é—´ä»¶ç³»ç»Ÿ
- æ·»åŠ çŠ¶æ€è®¢é˜…å’Œé€‰æ‹©å™¨ä¼˜åŒ–

### 6.2 React Query æ•°æ®è·å–å±‚ (3å°æ—¶)
- é…ç½® React Query å®¢æˆ·ç«¯å’Œç¼“å­˜ç­–ç•¥
- å®ç°æ•°æ®è·å– hooks å’ŒæŸ¥è¯¢é”®ç®¡ç†
- å»ºç«‹é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- æ”¯æŒä¹è§‚æ›´æ–°å’Œç¼“å­˜å¤±æ•ˆ

### 6.3 çŠ¶æ€æŒä¹…åŒ–ç³»ç»Ÿ (2å°æ—¶)
- å®ç°çŠ¶æ€æŒä¹…åŒ–ä¸­é—´ä»¶
- æ”¯æŒé€‰æ‹©æ€§æŒä¹…åŒ–å’Œæ•°æ®è¿ç§»
- æ·»åŠ æ•°æ®åŠ å¯†å’Œå®‰å…¨å­˜å‚¨
- å®ç°è·¨ Tab çŠ¶æ€åŒæ­¥

### 6.4 å¼€å‘å·¥å…·å’Œè°ƒè¯• (1å°æ—¶)
- é›†æˆ Redux DevTools æ”¯æŒ
- æ·»åŠ çŠ¶æ€å˜åŒ–æ—¥å¿—å’Œæ€§èƒ½ç›‘æ§
- åˆ›å»ºçŠ¶æ€è°ƒè¯•é¢æ¿
- å®ç°çŠ¶æ€å›æ”¾å’Œæµ‹è¯•å·¥å…·

## ğŸ”§ æŠ€æœ¯è¦æ±‚

### Zustand Store ç»“æ„
```typescript
// èŠå¤©çŠ¶æ€ç®¡ç†
interface ChatStore {
  // çŠ¶æ€
  messages: Message[];
  currentConversation: string | null;
  isLoading: boolean;
  aiTyping: boolean;

  // æ“ä½œ
  addMessage: (message: Message) => void;
  updateMessage: (id: string, updates: Partial<Message>) => void;
  clearMessages: () => void;
  setCurrentConversation: (id: string) => void;
  setLoading: (loading: boolean) => void;
}

// Widget çŠ¶æ€ç®¡ç†
interface WidgetStore {
  // çŠ¶æ€
  isOpen: boolean;
  mode: 'floating' | 'embedded';
  position: Position;
  size: Size;
  theme: ThemeConfig;

  // æ“ä½œ
  toggleWidget: () => void;
  setMode: (mode: 'floating' | 'embedded') => void;
  updatePosition: (position: Position) => void;
  updateSize: (size: Size) => void;
  setTheme: (theme: ThemeConfig) => void;
}
```

### React Query é…ç½®
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 åˆ†é’Ÿ
      cacheTime: 10 * 60 * 1000, // 10 åˆ†é’Ÿ
      retry: 3,
      refetchOnWindowFocus: false,
    },
    mutations: {
      retry: 1,
    },
  },
});
```

### çŠ¶æ€æŒä¹…åŒ–é…ç½®
```typescript
interface PersistenceConfig {
  key: string;
  storage: 'localStorage' | 'sessionStorage' | 'memory';
  whitelist?: string[];
  blacklist?: string[];
  encrypt?: boolean;
  version?: number;
  migrate?: (oldState: any, version: number) => any;
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ chatStore.ts
â”‚   â”œâ”€â”€ widgetStore.ts
â”‚   â”œâ”€â”€ userStore.ts
â”‚   â”œâ”€â”€ uiStore.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useChatStore.ts
â”‚   â”œâ”€â”€ useWidgetStore.ts
â”‚   â”œâ”€â”€ usePersistedStore.ts
â”‚   â””â”€â”€ useStoreSync.ts
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ queryClient.ts
â”‚   â”œâ”€â”€ apiClient.ts
â”‚   â””â”€â”€ persistence.ts
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ persistenceMiddleware.ts
â”‚   â”œâ”€â”€ loggerMiddleware.ts
â”‚   â””â”€â”€ syncMiddleware.ts
â”œâ”€â”€ queries/
â”‚   â”œâ”€â”€ useChatQueries.ts
â”‚   â”œâ”€â”€ useUserQueries.ts
â”‚   â””â”€â”€ useWidgetQueries.ts
â””â”€â”€ types/
    â”œâ”€â”€ store.ts
    â””â”€â”€ query.ts
```

## âœ… æµ‹è¯•è¦æ±‚

- [ ] çŠ¶æ€æ›´æ–°æ­£ç¡®è§¦å‘ç»„ä»¶é‡æ¸²æŸ“
- [ ] React Query ç¼“å­˜ç­–ç•¥å·¥ä½œæ­£å¸¸
- [ ] çŠ¶æ€æŒä¹…åŒ–åŠŸèƒ½å®Œæ•´
- [ ] çŠ¶æ€è®¢é˜…å’Œé€‰æ‹©å™¨ä¼˜åŒ–æœ‰æ•ˆ
- [ ] å¼€å‘å·¥å…·é›†æˆæ­£å¸¸
- [ ] æ€§èƒ½ç›‘æ§æ˜¾ç¤ºä¼˜åŒ–æ•ˆæœ

## ğŸš€ äº¤ä»˜ç‰©

- [ ] å®Œæ•´çš„ Zustand çŠ¶æ€ç®¡ç†æ¶æ„
- [ ] React Query æ•°æ®è·å–å±‚é…ç½®
- [ ] çŠ¶æ€æŒä¹…åŒ–ä¸­é—´ä»¶å’Œå·¥å…·
- [ ] çŠ¶æ€ç®¡ç†æ–‡æ¡£å’Œæœ€ä½³å®è·µ
- [ ] å¼€å‘å·¥å…·é›†æˆå’Œè°ƒè¯•é¢æ¿

## ğŸ“š å‚è€ƒèµ„æ–™

- [Zustand å®˜æ–¹æ–‡æ¡£](https://github.com/pmndrs/zustand)
- [React Query æ–‡æ¡£](https://tanstack.com/query/latest)
- [React çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ](https://react.dev/learn/state-a-components-memory)
- [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API)
- [Redux DevTools æ‰©å±•](https://github.com/reduxjs/redux-devtools)
