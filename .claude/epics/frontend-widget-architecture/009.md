---
title: "测试和部署 - 完善测试套件、CI/CD 流程、监控系统"
description: "建立完整的测试体系、CI/CD自动化部署流程和监控系统，确保前端Widget的质量、稳定性和可维护性，支持快速迭代和可靠交付"
date: "2025-10-07T05:19:46Z"
epic: "frontend-widget-architecture"
status: "pending"
priority: "high"
estimated_hours: 45
dependencies: ["001", "002", "003", "004", "005", "006"]
parallel: true
tags: ["testing", "deployment", "ci-cd", "monitoring", "quality-assurance"]
assignee: ""
---

## 任务概述

构建全面的测试体系和CI/CD流水线，实现自动化测试、构建、部署和监控。确保前端Widget在各种环境和场景下的质量稳定性，建立完善的监控告警机制，支持持续集成和持续部署的最佳实践。

## 验收标准

### 测试要求
- [ ] 单元测试覆盖率 > 90%
- [ ] 集成测试覆盖核心业务流程
- [ ] E2E测试覆盖关键用户场景
- [ ] 性能测试自动化执行
- [ ] 安全测试集成到CI/CD

### 部署要求
- [ ] CI/CD流水线完全自动化
- [ ] 多环境部署支持（开发、测试、预生产、生产）
- [ ] 蓝绿部署和回滚机制
- [ ] 版本管理和发布策略
- [ ] 部署时间 < 10分钟

### 监控要求
- [ ] 实时性能监控
- [ ] 错误追踪和告警
- [ ] 用户体验监控
- [ ] 业务指标监控
- [ ] 监控仪表板和报告

## 详细需求

### 1. 测试体系架构

#### 1.1 单元测试框架
```typescript
// Jest + React Testing Library 配置
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/test/setup.ts'],
  moduleNameMapping: {
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
    '^@/(.*)$': '<rootDir>/src/$1'
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/test/**/*',
    '!src/index.tsx'
  ],
  coverageThreshold: {
    global: {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  },
  testMatch: [
    '<rootDir>/src/**/__tests__/**/*.{ts,tsx}',
    '<rootDir>/src/**/*.{test,spec}.{ts,tsx}'
  ]
};

// 测试工具配置
// src/test/setup.ts
import '@testing-library/jest-dom';
import { configure } from '@testing-library/react';

// 配置Testing Library
configure({ testIdAttribute: 'data-testid' });

// Mock IntersectionObserver
global.IntersectionObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn()
}));

// Mock ResizeObserver
global.ResizeObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn()
}));

// Mock WebSocket
global.WebSocket = jest.fn().mockImplementation(() => ({
  close: jest.fn(),
  send: jest.fn(),
  addEventListener: jest.fn(),
  removeEventListener: jest.fn()
}));
```

#### 1.2 组件测试示例
```typescript
// ChatInterface.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { ChatInterface } from '../ChatInterface';
import { WebSocketProvider } from '../../contexts/WebSocketContext';
import { ThemeProvider } from '../../contexts/ThemeContext';

// 测试工具函数
const renderWithProviders = (component: React.ReactElement) => {
  return render(
    <ThemeProvider>
      <WebSocketProvider>
        {component}
      </WebSocketProvider>
    </ThemeProvider>
  );
};

// Mock数据
const mockMessages = [
  {
    id: '1',
    content: 'Hello',
    type: 'user',
    timestamp: Date.now()
  },
  {
    id: '2',
    content: 'Hi there!',
    type: 'assistant',
    timestamp: Date.now()
  }
];

describe('ChatInterface', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('renders chat interface correctly', () => {
    renderWithProviders(<ChatInterface />);

    expect(screen.getByTestId('chat-interface')).toBeInTheDocument();
    expect(screen.getByTestId('message-input')).toBeInTheDocument();
    expect(screen.getByTestId('send-button')).toBeInTheDocument();
  });

  it('displays messages correctly', () => {
    renderWithProviders(<ChatInterface messages={mockMessages} />);

    mockMessages.forEach(message => {
      expect(screen.getByText(message.content)).toBeInTheDocument();
    });
  });

  it('sends message when send button is clicked', async () => {
    const user = userEvent.setup();
    const mockSendMessage = jest.fn();

    renderWithProviders(
      <ChatInterface onSendMessage={mockSendMessage} />
    );

    const input = screen.getByTestId('message-input');
    const sendButton = screen.getByTestId('send-button');

    await user.type(input, 'Test message');
    await user.click(sendButton);

    expect(mockSendMessage).toHaveBeenCalledWith('Test message');
    expect(input).toHaveValue('');
  });

  it('handles keyboard shortcuts', async () => {
    const user = userEvent.setup();
    const mockSendMessage = jest.fn();

    renderWithProviders(
      <ChatInterface onSendMessage={mockSendMessage} />
    );

    const input = screen.getByTestId('message-input');

    await user.type(input, 'Test message');
    await user.keyboard('{Enter}');

    expect(mockSendMessage).toHaveBeenCalledWith('Test message');
  });

  it('shows loading state', () => {
    renderWithProviders(<ChatInterface isLoading={true} />);

    expect(screen.getByTestId('loading-indicator')).toBeInTheDocument();
  });

  it('handles error states', () => {
    const error = new Error('Connection failed');

    renderWithProviders(<ChatInterface error={error} />);

    expect(screen.getByText(/connection failed/i)).toBeInTheDocument();
  });
});

// 自定义Hook测试
// hooks/useChatMessages.test.ts
import { renderHook, act } from '@testing-library/react';
import { useChatMessages } from '../useChatMessages';

describe('useChatMessages', () => {
  it('initializes with empty messages', () => {
    const { result } = renderHook(() => useChatMessages());

    expect(result.current.messages).toEqual([]);
    expect(result.current.isLoading).toBe(false);
  });

  it('adds message correctly', () => {
    const { result } = renderHook(() => useChatMessages());

    act(() => {
      result.current.addMessage({
        id: '1',
        content: 'Test message',
        type: 'user'
      });
    });

    expect(result.current.messages).toHaveLength(1);
    expect(result.current.messages[0].content).toBe('Test message');
  });

  it('clears messages correctly', () => {
    const { result } = renderHook(() => useChatMessages());

    act(() => {
      result.current.addMessage({
        id: '1',
        content: 'Test message',
        type: 'user'
      });
      result.current.clearMessages();
    });

    expect(result.current.messages).toEqual([]);
  });
});
```

#### 1.3 集成测试
```typescript
// integration/api.integration.test.ts
import { setupServer } from 'msw/node';
import { rest } from 'msw';
import { SecureAPIClient } from '../security/SecureAPIClient';

// Mock服务器设置
const server = setupServer(
  rest.get('/api/messages', (req, res, ctx) => {
    return res(
      ctx.status(200),
      ctx.json({
        messages: [
          { id: '1', content: 'Hello', type: 'user' },
          { id: '2', content: 'Hi', type: 'assistant' }
        ]
      })
    );
  }),

  rest.post('/api/messages', (req, res, ctx) => {
    return res(
      ctx.status(201),
      ctx.json({
        id: '3',
        content: req.body.content,
        type: 'user',
        timestamp: Date.now()
      })
    );
  }),

  rest.get('/api/auth/token', (req, res, ctx) => {
    return res(
      ctx.status(401),
      ctx.json({ error: 'Unauthorized' })
    );
  })
});

describe('API Integration Tests', () => {
  const apiClient = new SecureAPIClient('http://localhost:3000');

  beforeAll(() => server.listen());
  afterEach(() => server.resetHandlers());
  afterAll(() => server.close());

  it('fetches messages successfully', async () => {
    const response = await apiClient.get('/api/messages');

    expect(response.messages).toHaveLength(2);
    expect(response.messages[0].content).toBe('Hello');
  });

  it('sends message successfully', async () => {
    const messageData = { content: 'New message', type: 'user' };

    const response = await apiClient.post('/api/messages', messageData);

    expect(response.id).toBe('3');
    expect(response.content).toBe('New message');
  });

  it('handles authentication errors', async () => {
    await expect(apiClient.get('/api/auth/token')).rejects.toThrow('Unauthorized');
  });
});

// WebSocket集成测试
// integration/websocket.integration.test.ts
import { WebSocketServer } from 'ws';
import { WebSocketManager } from '../services/WebSocketManager';

describe('WebSocket Integration Tests', () => {
  let wsServer: WebSocketServer;
  let wsManager: WebSocketManager;
  const WS_PORT = 8080;

  beforeEach(() => {
    wsServer = new WebSocketServer({ port: WS_PORT });
    wsManager = new WebSocketManager(`ws://localhost:${WS_PORT}`);
  });

  afterEach(() => {
    wsServer.close();
    wsManager.disconnect();
  });

  it('connects to WebSocket server', (done) => {
    wsServer.on('connection', (ws) => {
      expect(ws.readyState).toBe(1); // WebSocket.OPEN
      done();
    });

    wsManager.connect();
  });

  it('receives messages correctly', (done) => {
    const testMessage = { type: 'chat', content: 'Hello' };

    wsManager.onMessage((message) => {
      expect(message).toEqual(testMessage);
      done();
    });

    wsServer.on('connection', (ws) => {
      ws.send(JSON.stringify(testMessage));
    });

    wsManager.connect();
  });

  it('sends messages correctly', (done) => {
    const testMessage = { type: 'chat', content: 'Hello' };

    wsServer.on('connection', (ws) => {
      ws.on('message', (data) => {
        expect(JSON.parse(data.toString())).toEqual(testMessage);
        done();
      });
    });

    wsManager.connect();
    wsManager.sendMessage(testMessage);
  });
});
```

#### 1.4 E2E测试
```typescript
// cypress.config.ts
import { defineConfig } from 'cypress';

export default defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3000',
    supportFile: 'cypress/support/e2e.ts',
    specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',
    viewportWidth: 1280,
    viewportHeight: 720,
    video: true,
    screenshotOnRunFailure: true,
    defaultCommandTimeout: 10000,
    requestTimeout: 10000,
    responseTimeout: 10000
  },
  component: {
    devServer: {
      framework: 'react',
      bundler: 'vite'
    }
  }
});

// cypress/e2e/chat-widget.cy.ts
describe('Chat Widget E2E Tests', () => {
  beforeEach(() => {
    cy.visit('/');
    cy.get('[data-testid="chat-widget"]').should('be.visible');
  });

  it('opens chat widget', () => {
    cy.get('[data-testid="chat-toggle"]').click();
    cy.get('[data-testid="chat-interface"]').should('be.visible');
  });

  it('sends and receives messages', () => {
    cy.get('[data-testid="chat-toggle"]').click();

    // 发送消息
    cy.get('[data-testid="message-input"]')
      .type('Hello, this is a test message');
    cy.get('[data-testid="send-button"]').click();

    // 验证消息已发送
    cy.get('[data-testid="message-list"]')
      .should('contain', 'Hello, this is a test message');

    // 等待回复（模拟）
    cy.wait(2000);

    // 验证收到回复
    cy.get('[data-testid="message-list"]')
      .find('[data-message-type="assistant"]')
      .should('be.visible');
  });

  it('displays typing indicator', () => {
    cy.get('[data-testid="chat-toggle"]').click();

    cy.get('[data-testid="message-input"]')
      .type('Test typing');

    cy.get('[data-testid="typing-indicator"]')
      .should('be.visible');
  });

  it('handles connection errors gracefully', () => {
    // 模拟网络错误
    cy.intercept('GET', '/api/health', { forceNetworkError: true });

    cy.get('[data-testid="chat-toggle"]').click();

    cy.get('[data-testid="error-message"]')
      .should('be.visible')
      .and('contain', 'Connection failed');
  });

  it('maintains message history', () => {
    cy.get('[data-testid="chat-toggle"]').click();

    // 发送多条消息
    const messages = ['First message', 'Second message', 'Third message'];

    messages.forEach(message => {
      cy.get('[data-testid="message-input"]').clear().type(message);
      cy.get('[data-testid="send-button"]').click();
      cy.wait(500);
    });

    // 验证所有消息都在历史中
    messages.forEach(message => {
      cy.get('[data-testid="message-list"]')
        .should('contain', message);
    });

    // 刷新页面
    cy.reload();

    // 验证消息历史仍然存在
    cy.get('[data-testid="chat-toggle"]').click();
    messages.forEach(message => {
      cy.get('[data-testid="message-list"]')
        .should('contain', message);
    });
  });
});

// 性能测试
// cypress/e2e/performance.cy.ts
describe('Performance Tests', () => {
  it('loads within performance budget', () => {
    cy.visit('/');

    // 检查Core Web Vitals
    cy.getCoreWebVitals().should((vitals) => {
      expect(vitals.lcp).to.be.lessThan(2500); // Largest Contentful Paint
      expect(vitals.fid).to.be.lessThan(100);  // First Input Delay
      expect(vitals.cls).to.be.lessThan(0.1);  // Cumulative Layout Shift
    });
  });

  it('handles large message lists efficiently', () => {
    // 生成大量消息
    const largeMessageList = Array.from({ length: 1000 }, (_, i) => ({
      id: `msg-${i}`,
      content: `Message ${i}`,
      type: i % 2 === 0 ? 'user' : 'assistant'
    }));

    cy.visit('/', {
      onBeforeLoad: (win) => {
        win.localStorage.setItem('chat-messages', JSON.stringify(largeMessageList));
      }
    });

    cy.get('[data-testid="chat-toggle"]').click();

    // 验证虚拟滚动工作正常
    cy.get('[data-testid="virtual-scroll-container"]').should('be.visible');

    // 验证性能
    cy.window().then((win) => {
      expect(win.performance.timing.loadEventEnd - win.performance.timing.navigationStart)
        .to.be.lessThan(3000);
    });
  });
});
```

### 2. CI/CD流水线

#### 2.1 GitHub Actions配置
```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # 代码质量检查
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: ESLint
        run: npm run lint

      - name: Prettier check
        run: npm run format:check

      - name: Accessibility check
        run: npm run test:a11y

  # 单元测试
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit -- --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # 集成测试
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    services:
      # 模拟后端服务
      api:
        image: node:18-alpine
        ports:
          - 3001:3001
        env:
          NODE_ENV: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration
        env:
          API_BASE_URL: http://localhost:3001

  # E2E测试
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Start application
        run: npm run preview &
        env:
          PORT: 3000

      - name: Wait for application
        run: npx wait-on http://localhost:3000

      - name: Run E2E tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: .
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120

      - name: Upload videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos

  # 安全扫描
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:3000'

  # 构建和部署
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, integration-tests, e2e-tests, security]

    if: github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://widget.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env file
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.API_BASE_URL }}" > .env.production
          echo "VITE_WS_URL=${{ secrets.WS_URL }}" >> .env.production

      - name: Build application
        run: npm run build

      - name: Optimize bundle
        run: npm run build:analyze

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod'

      - name: Run smoke tests
        run: npm run test:smoke
        env:
          BASE_URL: https://widget.example.com

  # 性能测试
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build-and-deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Run WebPageTest
        uses: webpagetest/webpagetest-action@v1
        with:
          url: https://widget.example.com
          key: ${{ secrets.WEBPAGETEST_API_KEY }}
```

#### 2.2 部署脚本
```bash
#!/bin/bash
# scripts/deploy.sh

set -e

# 配置变量
ENVIRONMENT=${1:-production}
BUILD_DIR="dist"
BACKUP_DIR="/var/backups/widget"
REMOTE_HOST="deploy@example.com"
REMOTE_PATH="/var/www/widget"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
    exit 1
}

# 检查环境
check_environment() {
    log "Checking environment..."

    if [ ! -f ".env.${ENVIRONMENT}" ]; then
        error "Environment file .env.${ENVIRONMENT} not found"
    fi

    if ! command -v ssh &> /dev/null; then
        error "SSH client not found"
    fi

    if ! command -v rsync &> /dev/null; then
        error "rsync not found"
    fi
}

# 构建应用
build_application() {
    log "Building application for ${ENVIRONMENT}..."

    # 加载环境变量
    cp .env.${ENVIRONMENT} .env.production

    # 安装依赖
    npm ci --production=false

    # 构建应用
    npm run build

    # 验证构建结果
    if [ ! -d "$BUILD_DIR" ]; then
        error "Build failed - dist directory not found"
    fi

    log "Build completed successfully"
}

# 运行测试
run_tests() {
    log "Running tests..."

    # 单元测试
    npm run test:unit

    # 集成测试
    npm run test:integration

    # 烟雾测试
    npm run test:smoke

    log "All tests passed"
}

# 备份当前版本
backup_current_version() {
    log "Backing up current version..."

    ssh $REMOTE_HOST "mkdir -p $BACKUP_DIR"
    ssh $REMOTE_HOST "sudo cp -r $REMOTE_PATH $BACKUP_DIR/widget-$(date +%Y%m%d-%H%M%S)" || true

    log "Backup completed"
}

# 部署应用
deploy_application() {
    log "Deploying application..."

    # 同步文件
    rsync -avz --delete \
        -e "ssh -o StrictHostKeyChecking=no" \
        $BUILD_DIR/ \
        $REMOTE_HOST:$REMOTE_PATH/

    # 设置权限
    ssh $REMOTE_HOST "sudo chown -R www-data:www-data $REMOTE_PATH"
    ssh $REMOTE_HOST "sudo chmod -R 755 $REMOTE_PATH"

    # 重启服务
    ssh $REMOTE_HOST "sudo systemctl reload nginx" || true

    log "Deployment completed"
}

# 健康检查
health_check() {
    log "Running health check..."

    local url="https://widget.example.com"
    local max_attempts=30
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        if curl -f -s "$url/health" > /dev/null; then
            log "Health check passed"
            return 0
        fi

        warn "Health check attempt $attempt/$max_attempts failed"
        sleep 10
        ((attempt++))
    done

    error "Health check failed after $max_attempts attempts"
}

# 回滚函数
rollback() {
    warn "Rolling back to previous version..."

    local latest_backup=$(ssh $REMOTE_HOST "ls -t $BACKUP_DIR | head -1")

    if [ -n "$latest_backup" ]; then
        ssh $REMOTE_HOST "sudo rm -rf $REMOTE_PATH"
        ssh $REMOTE_HOST "sudo mv $BACKUP_DIR/$latest_backup $REMOTE_PATH"
        ssh $REMOTE_HOST "sudo systemctl reload nginx"

        log "Rollback completed"
    else
        error "No backup found for rollback"
    fi
}

# 主流程
main() {
    log "Starting deployment for ${ENVIRONMENT} environment"

    check_environment
    build_application
    run_tests
    backup_current_version
    deploy_application

    if health_check; then
        log "Deployment completed successfully!"
    else
        warn "Health check failed, initiating rollback..."
        rollback
        exit 1
    fi
}

# 错误处理
trap 'error "Deployment failed at line $LINENO"' ERR

# 执行主流程
main "$@"
```

### 3. 监控系统

#### 3.1 性能监控
```typescript
// monitoring/PerformanceMonitor.ts
class PerformanceMonitor {
  private metrics: PerformanceMetric[] = [];
  private observers: PerformanceObserver[] = [];

  constructor() {
    this.initObservers();
    this.trackWebVitals();
    this.trackUserInteractions();
  }

  // 初始化性能观察器
  private initObservers(): void {
    // 监控长任务
    const longTaskObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        this.recordMetric({
          name: 'long-task',
          value: entry.duration,
          timestamp: entry.startTime,
          details: {
            name: (entry as PerformanceEntry).name,
            startTime: entry.startTime
          }
        });
      }
    });

    longTaskObserver.observe({ entryTypes: ['longtask'] });
    this.observers.push(longTaskObserver);

    // 监控资源加载
    const resourceObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        this.recordMetric({
          name: 'resource-load',
          value: entry.duration,
          timestamp: entry.startTime,
          details: {
            name: entry.name,
            type: (entry as PerformanceResourceTiming).initiatorType,
            size: (entry as PerformanceResourceTiming).transferSize
          }
        });
      }
    });

    resourceObserver.observe({ entryTypes: ['resource'] });
    this.observers.push(resourceObserver);

    // 监控导航
    const navigationObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        const navEntry = entry as PerformanceNavigationTiming;
        this.recordMetric({
          name: 'navigation',
          value: navEntry.loadEventEnd - navEntry.fetchStart,
          timestamp: navEntry.fetchStart,
          details: {
            domContentLoaded: navEntry.domContentLoadedEventEnd - navEntry.fetchStart,
            loadComplete: navEntry.loadEventEnd - navEntry.fetchStart,
            redirectCount: navEntry.redirectCount
          }
        });
      }
    });

    navigationObserver.observe({ entryTypes: ['navigation'] });
    this.observers.push(navigationObserver);
  }

  // Web Vitals监控
  private trackWebVitals(): void {
    // Largest Contentful Paint (LCP)
    this.observeLCP();

    // First Input Delay (FID)
    this.observeFID();

    // Cumulative Layout Shift (CLS)
    this.observeCLS();
  }

  private observeLCP(): void {
    new PerformanceObserver((list) => {
      const entries = list.getEntries();
      const lastEntry = entries[entries.length - 1];

      this.recordMetric({
        name: 'lcp',
        value: lastEntry.startTime,
        timestamp: Date.now(),
        details: {
          element: (lastEntry as any).element?.tagName || 'unknown',
          url: (lastEntry as any).url || ''
        }
      });
    }).observe({ entryTypes: ['largest-contentful-paint'] });
  }

  private observeFID(): void {
    new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        this.recordMetric({
          name: 'fid',
          value: (entry as any).processingStart - entry.startTime,
          timestamp: Date.now(),
          details: {
            eventType: (entry as any).name
          }
        });
      }
    }).observe({ entryTypes: ['first-input'] });
  }

  private observeCLS(): void {
    let clsValue = 0;

    new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (!(entry as any).hadRecentInput) {
          clsValue += (entry as any).value;

          this.recordMetric({
            name: 'cls',
            value: clsValue,
            timestamp: Date.now(),
            details: {
              value: (entry as any).value
            }
          });
        }
      }
    }).observe({ entryTypes: ['layout-shift'] });
  }

  // 用户交互监控
  private trackUserInteractions(): void {
    // 点击响应时间
    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      const startTime = performance.now();

      requestAnimationFrame(() => {
        const responseTime = performance.now() - startTime;

        this.recordMetric({
          name: 'click-response',
          value: responseTime,
          timestamp: Date.now(),
          details: {
            tagName: target.tagName,
            className: target.className,
            id: target.id
          }
        });
      });
    });

    // 表单提交时间
    document.addEventListener('submit', (event) => {
      const form = event.target as HTMLFormElement;
      const startTime = performance.now();

      // 监听表单提交完成
      const observer = new MutationObserver(() => {
        const submitTime = performance.now() - startTime;

        this.recordMetric({
          name: 'form-submit',
          value: submitTime,
          timestamp: Date.now(),
          details: {
            formId: form.id,
            formName: form.name
          }
        });

        observer.disconnect();
      });

      observer.observe(document.body, { childList: true, subtree: true });
    });
  }

  // 记录指标
  private recordMetric(metric: PerformanceMetric): void {
    this.metrics.push(metric);

    // 保持指标数量在合理范围内
    if (this.metrics.length > 1000) {
      this.metrics = this.metrics.slice(-500);
    }

    // 发送到监控服务
    this.sendMetric(metric);
  }

  // 自定义指标记录
  recordCustomMetric(name: string, value: number, details?: any): void {
    this.recordMetric({
      name,
      value,
      timestamp: Date.now(),
      details: details || {}
    });
  }

  // 发送指标到服务器
  private async sendMetric(metric: PerformanceMetric): Promise<void> {
    try {
      await fetch('/api/metrics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(metric)
      });
    } catch (error) {
      console.error('Failed to send metric:', error);
    }
  }

  // 获取性能报告
  getPerformanceReport(): PerformanceReport {
    const now = Date.now();
    const last24Hours = this.metrics.filter(m => now - m.timestamp < 86400000);

    return {
      totalMetrics: this.metrics.length,
      last24Hours: last24Hours.length,
      webVitals: this.getWebVitals(last24Hours),
      resourceMetrics: this.getResourceMetrics(last24Hours),
      userInteractionMetrics: this.getUserInteractionMetrics(last24Hours),
      recommendations: this.generateRecommendations(last24Hours)
    };
  }

  private getWebVitals(metrics: PerformanceMetric[]): WebVitals {
    const lcp = metrics.find(m => m.name === 'lcp');
    const fid = metrics.find(m => m.name === 'fid');
    const cls = metrics.find(m => m.name === 'cls');

    return {
      lcp: lcp?.value || 0,
      fid: fid?.value || 0,
      cls: cls?.value || 0,
      lcpRating: this.getLCPRating(lcp?.value || 0),
      fidRating: this.getFIDRating(fid?.value || 0),
      clsRating: this.getCLSRating(cls?.value || 0)
    };
  }

  private getResourceMetrics(metrics: PerformanceMetric[]): ResourceMetrics {
    const resourceMetrics = metrics.filter(m => m.name === 'resource-load');

    const totalLoadTime = resourceMetrics.reduce((sum, m) => sum + m.value, 0);
    const totalSize = resourceMetrics.reduce((sum, m) => sum + (m.details.size || 0), 0);

    return {
      averageLoadTime: resourceMetrics.length > 0 ? totalLoadTime / resourceMetrics.length : 0,
      totalResources: resourceMetrics.length,
      totalSize,
      slowResources: resourceMetrics.filter(m => m.value > 1000).length
    };
  }

  private getUserInteractionMetrics(metrics: PerformanceMetric[]): UserInteractionMetrics {
    const clickMetrics = metrics.filter(m => m.name === 'click-response');
    const formMetrics = metrics.filter(m => m.name === 'form-submit');

    return {
      averageClickResponse: clickMetrics.length > 0
        ? clickMetrics.reduce((sum, m) => sum + m.value, 0) / clickMetrics.length
        : 0,
      averageFormSubmit: formMetrics.length > 0
        ? formMetrics.reduce((sum, m) => sum + m.value, 0) / formMetrics.length
        : 0,
      totalInteractions: clickMetrics.length + formMetrics.length
    };
  }

  private generateRecommendations(metrics: PerformanceMetric[]): string[] {
    const recommendations: string[] = [];

    const lcp = metrics.find(m => m.name === 'lcp');
    if (lcp && lcp.value > 2500) {
      recommendations.push('优化LCP时间：考虑优化图片加载、减少服务器响应时间');
    }

    const cls = metrics.find(m => m.name === 'cls');
    if (cls && cls.value > 0.1) {
      recommendations.push('减少CLS：为图片和广告设置明确尺寸，避免内容偏移');
    }

    const slowResources = metrics.filter(m => m.name === 'resource-load' && m.value > 1000);
    if (slowResources.length > 0) {
      recommendations.push(`发现${slowResources.length}个慢加载资源，建议优化或缓存`);
    }

    return recommendations;
  }

  private getLCPRating(value: number): 'good' | 'needs-improvement' | 'poor' {
    if (value <= 2500) return 'good';
    if (value <= 4000) return 'needs-improvement';
    return 'poor';
  }

  private getFIDRating(value: number): 'good' | 'needs-improvement' | 'poor' {
    if (value <= 100) return 'good';
    if (value <= 300) return 'needs-improvement';
    return 'poor';
  }

  private getCLSRating(value: number): 'good' | 'needs-improvement' | 'poor' {
    if (value <= 0.1) return 'good';
    if (value <= 0.25) return 'needs-improvement';
    return 'poor';
  }

  // 清理资源
  destroy(): void {
    this.observers.forEach(observer => observer.disconnect());
    this.observers = [];
  }
}

// 接口定义
interface PerformanceMetric {
  name: string;
  value: number;
  timestamp: number;
  details: any;
}

interface PerformanceReport {
  totalMetrics: number;
  last24Hours: number;
  webVitals: WebVitals;
  resourceMetrics: ResourceMetrics;
  userInteractionMetrics: UserInteractionMetrics;
  recommendations: string[];
}

interface WebVitals {
  lcp: number;
  fid: number;
  cls: number;
  lcpRating: 'good' | 'needs-improvement' | 'poor';
  fidRating: 'good' | 'needs-improvement' | 'poor';
  clsRating: 'good' | 'needs-improvement' | 'poor';
}

interface ResourceMetrics {
  averageLoadTime: number;
  totalResources: number;
  totalSize: number;
  slowResources: number;
}

interface UserInteractionMetrics {
  averageClickResponse: number;
  averageFormSubmit: number;
  totalInteractions: number;
}

export { PerformanceMonitor };
```

#### 3.2 错误监控
```typescript
// monitoring/ErrorMonitor.ts
class ErrorMonitor {
  private errors: ErrorEvent[] = [];
  private readonly MAX_ERRORS = 100;

  constructor() {
    this.setupGlobalHandlers();
    this.setupUnhandledRejectionHandler();
  }

  // 设置全局错误处理
  private setupGlobalHandlers(): void {
    window.addEventListener('error', (event) => {
      this.recordError({
        type: 'javascript',
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href
      });
    });

    window.addEventListener('error', (event) => {
      if (event.target !== window) {
        this.recordError({
          type: 'resource',
          message: `Failed to load resource: ${(event.target as any)?.src || (event.target as any)?.href}`,
          element: (event.target as any)?.tagName,
          source: (event.target as any)?.src || (event.target as any)?.href,
          timestamp: Date.now(),
          userAgent: navigator.userAgent,
          url: window.location.href
        });
      }
    }, true);
  }

  // 处理未捕获的Promise拒绝
  private setupUnhandledRejectionHandler(): void {
    window.addEventListener('unhandledrejection', (event) => {
      this.recordError({
        type: 'promise-rejection',
        message: event.reason?.message || 'Unhandled promise rejection',
        stack: event.reason?.stack,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href
      });
    });
  }

  // 记录错误
  private recordError(error: ErrorEvent): void {
    this.errors.push(error);

    // 保持错误队列大小
    if (this.errors.length > this.MAX_ERRORS) {
      this.errors.shift();
    }

    // 发送错误到服务器
    this.reportError(error);
  }

  // 手动报告错误
  reportError(error: ErrorEvent | Error | string, context?: any): void {
    let errorEvent: ErrorEvent;

    if (typeof error === 'string') {
      errorEvent = {
        type: 'manual',
        message: error,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href,
        context
      };
    } else if (error instanceof Error) {
      errorEvent = {
        type: 'manual',
        message: error.message,
        stack: error.stack,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href,
        context
      };
    } else {
      errorEvent = {
        ...error,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href
      };
    }

    this.recordError(errorEvent);
  }

  // 发送错误到服务器
  private async reportError(error: ErrorEvent): Promise<void> {
    try {
      await fetch('/api/errors', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(error)
      });
    } catch (reportError) {
      console.error('Failed to report error:', reportError);
    }
  }

  // 获取错误报告
  getErrorReport(): ErrorReport {
    const now = Date.now();
    const last24Hours = this.errors.filter(e => now - e.timestamp < 86400000);

    return {
      totalErrors: this.errors.length,
      last24Hours: last24Hours.length,
      errorTypes: this.getErrorTypeDistribution(last24Hours),
      criticalErrors: last24Hours.filter(e => this.isCriticalError(e)).length,
      recommendations: this.generateErrorRecommendations(last24Hours)
    };
  }

  private getErrorTypeDistribution(errors: ErrorEvent[]): Record<string, number> {
    return errors.reduce((acc, error) => {
      acc[error.type] = (acc[error.type] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);
  }

  private isCriticalError(error: ErrorEvent): boolean {
    const criticalTypes = ['javascript', 'promise-rejection'];
    return criticalTypes.includes(error.type);
  }

  private generateErrorRecommendations(errors: ErrorEvent[]): string[] {
    const recommendations: string[] = [];

    const jsErrors = errors.filter(e => e.type === 'javascript');
    if (jsErrors.length > 10) {
      recommendations.push('JavaScript错误较多，建议加强代码测试和错误处理');
    }

    const resourceErrors = errors.filter(e => e.type === 'resource');
    if (resourceErrors.length > 5) {
      recommendations.push('资源加载错误较多，建议检查资源URL和服务器状态');
    }

    return recommendations;
  }
}

interface ErrorEvent {
  type: string;
  message: string;
  filename?: string;
  lineno?: number;
  colno?: number;
  stack?: string;
  element?: string;
  source?: string;
  timestamp: number;
  userAgent: string;
  url: string;
  context?: any;
}

interface ErrorReport {
  totalErrors: number;
  last24Hours: number;
  errorTypes: Record<string, number>;
  criticalErrors: number;
  recommendations: string[];
}

export { ErrorMonitor };
```

#### 3.3 监控仪表板
```typescript
// monitoring/Dashboard.tsx
import React, { useState, useEffect } from 'react';
import { PerformanceMonitor } from './PerformanceMonitor';
import { ErrorMonitor } from './ErrorMonitor';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

interface MonitoringDashboardProps {
  apiBaseUrl: string;
}

const MonitoringDashboard: React.FC<MonitoringDashboardProps> = ({ apiBaseUrl }) => {
  const [performanceData, setPerformanceData] = useState<any[]>([]);
  const [errorData, setErrorData] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [timeRange, setTimeRange] = useState('24h');

  useEffect(() => {
    const performanceMonitor = new PerformanceMonitor();
    const errorMonitor = new ErrorMonitor();

    const fetchData = async () => {
      try {
        const [perfResponse, errorResponse] = await Promise.all([
          fetch(`${apiBaseUrl}/metrics/summary?range=${timeRange}`),
          fetch(`${apiBaseUrl}/errors/summary?range=${timeRange}`)
        ]);

        const perfData = await perfResponse.json();
        const errorData = await errorResponse.json();

        setPerformanceData(perfData.metrics);
        setErrorData(errorData.errors);
      } catch (error) {
        console.error('Failed to fetch monitoring data:', error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchData();
    const interval = setInterval(fetchData, 60000); // 每分钟刷新

    return () => {
      clearInterval(interval);
      performanceMonitor.destroy();
    };
  }, [apiBaseUrl, timeRange]);

  if (isLoading) {
    return <div className="flex justify-center items-center h-64">Loading monitoring data...</div>;
  }

  return (
    <div className="monitoring-dashboard p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold mb-4">系统监控仪表板</h1>

        {/* 时间范围选择器 */}
        <div className="flex space-x-2 mb-6">
          {['1h', '6h', '24h', '7d'].map(range => (
            <button
              key={range}
              onClick={() => setTimeRange(range)}
              className={`px-4 py-2 rounded ${
                timeRange === range
                  ? 'bg-blue-500 text-white'
                  : 'bg-gray-200 text-gray-700'
              }`}
            >
              {range}
            </button>
          ))}
        </div>
      </div>

      {/* 性能指标卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <MetricCard
          title="平均LCP"
          value={performanceData.lcp?.average || 0}
          unit="ms"
          status={getLCPStatus(performanceData.lcp?.average || 0)}
        />
        <MetricCard
          title="平均FID"
          value={performanceData.fid?.average || 0}
          unit="ms"
          status={getFIDStatus(performanceData.fid?.average || 0)}
        />
        <MetricCard
          title="平均CLS"
          value={performanceData.cls?.average || 0}
          unit=""
          status={getCLSStatus(performanceData.cls?.average || 0)}
        />
        <MetricCard
          title="错误率"
          value={errorData.errorRate || 0}
          unit="%"
          status={getErrorStatus(errorData.errorRate || 0)}
        />
      </div>

      {/* 图表区域 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        {/* 性能趋势图 */}
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-lg font-semibold mb-4">性能趋势</h2>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={performanceData.trend}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="time" />
              <YAxis />
              <Tooltip />
              <Line
                type="monotone"
                dataKey="lcp"
                stroke="#8884d8"
                name="LCP (ms)"
              />
              <Line
                type="monotone"
                dataKey="fid"
                stroke="#82ca9d"
                name="FID (ms)"
              />
            </LineChart>
          </ResponsiveContainer>
        </div>

        {/* 错误趋势图 */}
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-lg font-semibold mb-4">错误趋势</h2>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={errorData.trend}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="time" />
              <YAxis />
              <Tooltip />
              <Line
                type="monotone"
                dataKey="count"
                stroke="#ff7300"
                name="错误数量"
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* 详细信息表格 */}
      <div className="bg-white p-6 rounded-lg shadow">
        <h2 className="text-lg font-semibold mb-4">最近错误</h2>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  时间
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  类型
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  消息
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  频次
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {errorData.recent?.map((error: any, index: number) => (
                <tr key={index}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {new Date(error.timestamp).toLocaleString()}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span className={`px-2 py-1 rounded text-xs ${
                      error.type === 'javascript' ? 'bg-red-100 text-red-800' :
                      error.type === 'resource' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {error.type}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
                    {error.message}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {error.count}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// 指标卡片组件
interface MetricCardProps {
  title: string;
  value: number;
  unit: string;
  status: 'good' | 'warning' | 'critical';
}

const MetricCard: React.FC<MetricCardProps> = ({ title, value, unit, status }) => {
  const statusColors = {
    good: 'bg-green-100 text-green-800',
    warning: 'bg-yellow-100 text-yellow-800',
    critical: 'bg-red-100 text-red-800'
  };

  return (
    <div className="bg-white p-6 rounded-lg shadow">
      <h3 className="text-sm font-medium text-gray-500 mb-2">{title}</h3>
      <div className="flex items-baseline">
        <span className="text-2xl font-semibold text-gray-900">
          {value.toFixed(unit === '' ? 3 : 0)}
        </span>
        <span className="ml-1 text-sm text-gray-500">{unit}</span>
      </div>
      <div className="mt-2">
        <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${statusColors[status]}`}>
          {status}
        </span>
      </div>
    </div>
  );
};

// 状态判断函数
const getLCPStatus = (value: number): 'good' | 'warning' | 'critical' => {
  if (value <= 2500) return 'good';
  if (value <= 4000) return 'warning';
  return 'critical';
};

const getFIDStatus = (value: number): 'good' | 'warning' | 'critical' => {
  if (value <= 100) return 'good';
  if (value <= 300) return 'warning';
  return 'critical';
};

const getCLSStatus = (value: number): 'good' | 'warning' | 'critical' => {
  if (value <= 0.1) return 'good';
  if (value <= 0.25) return 'warning';
  return 'critical';
};

const getErrorStatus = (value: number): 'good' | 'warning' | 'critical' => {
  if (value <= 1) return 'good';
  if (value <= 5) return 'warning';
  return 'critical';
};

export { MonitoringDashboard };
```

## 技术方案

### 测试框架
- **单元测试**: Jest + React Testing Library
- **集成测试**: MSW (Mock Service Worker)
- **E2E测试**: Cypress
- **性能测试**: Lighthouse CI
- **安全测试**: OWASP ZAP, Snyk

### CI/CD工具
- **版本控制**: GitHub
- **CI/CD**: GitHub Actions
- **部署**: Vercel, AWS S3/CloudFront
- **监控**: DataDog, Sentry
- **通知**: Slack, Email

### 监控技术栈
- **性能监控**: Web Vitals, Performance API
- **错误监控**: Sentry, 自定义错误追踪
- **用户体验监控**: RUM (Real User Monitoring)
- **业务指标**: 自定义指标收集

## 开发计划

### 第1周：测试框架搭建
- Jest和Testing Library配置
- 基础单元测试编写
- Mock服务设置

### 第2周：CI/CD流水线
- GitHub Actions配置
- 自动化测试集成
- 基础部署流程

### 第3周：监控系统
- 性能监控实现
- 错误监控集成
- 监控仪表板开发

### 第4周：完善和优化
- 测试覆盖率提升
- CI/CD流程优化
- 监控告警完善

## 风险和依赖

### 技术风险
- 测试环境配置复杂
- CI/CD流水线稳定性
- 监控数据准确性

### 依赖关系
- 依赖所有功能模块完成
- 需要测试环境支持
- 需要监控服务配置

## 测试策略

### 自动化测试
- 代码提交触发测试
- 定时执行完整测试套件
- 性能回归测试
- 安全扫描自动化

### 手动测试
- UAT用户验收测试
- 兼容性测试
- 用户体验测试

## 部署和监控

### 部署策略
- 蓝绿部署
- 金丝雀发布
- 自动回滚机制

### 监控告警
- 实时性能监控
- 错误率告警
- 用户体验指标追踪
- 业务指标监控