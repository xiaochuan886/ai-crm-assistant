---
title: "è·¨åŸŸé€šä¿¡ç³»ç»Ÿ"
epic: "frontend-widget-architecture"
number: 2
batch: 1
status: "pending"
priority: "high"
estimated_hours: 12
tags: ["postmessage", "communication", "security", "validation"]
parallel: false
depends_on: [1]
assigned_to: ""
reviewer: ""
created_at: "2025-10-07T05:19:46Z"
updated_at: "2025-10-07T05:19:46Z"
---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å¼€å‘ postMessage é€šä¿¡åè®®å’Œæ¶ˆæ¯éªŒè¯ç³»ç»Ÿï¼Œå®ç° iframe åµŒå…¥å¼å°éƒ¨ä»¶ä¸çˆ¶é¡µé¢ä¹‹é—´çš„å®‰å…¨è·¨åŸŸé€šä¿¡ã€‚

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### æ ¸å¿ƒè¦æ±‚
- [x] postMessage åŒå‘é€šä¿¡åè®®å®ç°
- [x] æ¶ˆæ¯ç±»å‹å®šä¹‰å’ŒéªŒè¯æœºåˆ¶
- [x] å®‰å…¨çš„æ¥æºéªŒè¯å’Œé”™è¯¯å¤„ç†
- [x] äº‹ä»¶ç›‘å¬å™¨å’Œæ¶ˆæ¯å¤„ç†å™¨
- [x] è¿æ¥çŠ¶æ€ç®¡ç†å’Œé‡è¿æœºåˆ¶

### æŠ€æœ¯æ ‡å‡†
- [x] TypeScript ç±»å‹å®šä¹‰å®Œæ•´
- [x] æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–
- [x] é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [x] æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†

## ğŸ“ è¯¦ç»†ä»»åŠ¡

### 2.1 é€šä¿¡åè®®è®¾è®¡ (3å°æ—¶)
- å®šä¹‰æ¶ˆæ¯æ ¼å¼å’Œæ•°æ®ç»“æ„
- è®¾è®¡æ¶ˆæ¯ç±»å‹æšä¸¾
- åˆ¶å®šé€šä¿¡æ—¶åºå’Œæ¡æ‰‹åè®®

### 2.2 æ¶ˆæ¯éªŒè¯ç³»ç»Ÿ (3å°æ—¶)
- å®ç°æ¥æºéªŒè¯æœºåˆ¶
- åˆ›å»ºæ¶ˆæ¯æ ¼å¼éªŒè¯å™¨
- å¤„ç†æ¶æ„æ¶ˆæ¯å’Œå¼‚å¸¸æƒ…å†µ

### 2.3 äº‹ä»¶ç³»ç»Ÿå®ç° (4å°æ—¶)
- å¼€å‘ postMessage ç›‘å¬å™¨
- å®ç°æ¶ˆæ¯åˆ†å‘å’Œè·¯ç”±
- åˆ›å»ºäº‹ä»¶è®¢é˜…/å‘å¸ƒæœºåˆ¶

### 2.4 è¿æ¥ç®¡ç† (2å°æ—¶)
- å®ç°è¿æ¥çŠ¶æ€è·Ÿè¸ª
- æ·»åŠ é‡è¿å’Œå¿ƒè·³æœºåˆ¶
- å¤„ç†çª—å£å…³é—­å’Œé¡µé¢å¸è½½

## ğŸ”§ æŠ€æœ¯è¦æ±‚

### æ¶ˆæ¯æ ¼å¼
```typescript
interface WidgetMessage {
  id: string;
  type: MessageType;
  payload: any;
  timestamp: number;
  source: 'widget' | 'parent';
}

enum MessageType {
  HANDSHAKE = 'handshake',
  AUTH_TOKEN = 'auth_token',
  CRM_DATA = 'crm_data',
  WIDGET_READY = 'widget_ready',
  ERROR = 'error',
  PING = 'ping',
  PONG = 'pong'
}
```

### æ ¸å¿ƒç»„ä»¶
```typescript
class MessageBridge {
  private targetWindow: Window;
  private allowedOrigins: string[];
  private messageQueue: WidgetMessage[] = [];

  // å‘é€æ¶ˆæ¯
  sendMessage(type: MessageType, payload: any): void;

  // å¤„ç†æ¥æ”¶çš„æ¶ˆæ¯
  handleMessage(event: MessageEvent): void;

  // éªŒè¯æ¶ˆæ¯æ¥æº
  private validateOrigin(origin: string): boolean;

  // å»ºç«‹è¿æ¥
  establishConnection(): Promise<void>;
}
```

### å®‰å…¨æªæ–½
- æ¥æºç™½åå•éªŒè¯
- æ¶ˆæ¯å†…å®¹éªŒè¯å’Œæ¸…ç†
- é€Ÿç‡é™åˆ¶å’Œé˜²æŠ–æœºåˆ¶
- é”™è¯¯è¾¹ç•Œå’Œå¼‚å¸¸æ•è·

## âœ… æµ‹è¯•è¦æ±‚

- [x] è·¨åŸŸæ¶ˆæ¯å‘é€å’Œæ¥æ”¶æ­£å¸¸
- [x] æ¶ˆæ¯éªŒè¯æœºåˆ¶æœ‰æ•ˆ
- [x] æ¶æ„æ¶ˆæ¯è¢«æ­£ç¡®æ‹¦æˆª
- [x] è¿æ¥çŠ¶æ€ç®¡ç†å‡†ç¡®
- [x] é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

## ğŸš€ äº¤ä»˜ç‰©

- [x] MessageBridge æ ¸å¿ƒé€šä¿¡ç±»
- [x] æ¶ˆæ¯ç±»å‹å®šä¹‰å’Œæ¥å£
- [x] éªŒè¯å’Œå®‰å…¨æœºåˆ¶
- [x] è¿æ¥ç®¡ç†ç³»ç»Ÿ
- [x] ä½¿ç”¨ç¤ºä¾‹å’Œæ–‡æ¡£

## ğŸ“š å‚è€ƒèµ„æ–™

- [MDN postMessage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [Cross-origin communication security](https://web.dev/cross-origin-communication/)
- [Message passing in iframe](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [Window: message event](https://developer.mozilla.org/en-US/docs/Web/API/Window/message_event)