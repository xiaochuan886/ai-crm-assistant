---
title: "跨域通信系统"
epic: "frontend-widget-architecture"
number: 2
batch: 1
status: "pending"
priority: "high"
estimated_hours: 12
tags: ["postmessage", "communication", "security", "validation"]
parallel: false
depends_on: [1]
assigned_to: ""
reviewer: ""
created_at: "2025-10-07T05:19:46Z"
updated_at: "2025-10-07T05:19:46Z"
---

## 📋 任务概述

开发 postMessage 通信协议和消息验证系统，实现 iframe 嵌入式小部件与父页面之间的安全跨域通信。

## 🎯 验收标准

### 核心要求
- [x] postMessage 双向通信协议实现
- [x] 消息类型定义和验证机制
- [x] 安全的来源验证和错误处理
- [x] 事件监听器和消息处理器
- [x] 连接状态管理和重连机制

### 技术标准
- [x] TypeScript 类型定义完整
- [x] 消息格式标准化
- [x] 错误处理和日志记录
- [x] 性能优化和内存管理

## 📝 详细任务

### 2.1 通信协议设计 (3小时)
- 定义消息格式和数据结构
- 设计消息类型枚举
- 制定通信时序和握手协议

### 2.2 消息验证系统 (3小时)
- 实现来源验证机制
- 创建消息格式验证器
- 处理恶意消息和异常情况

### 2.3 事件系统实现 (4小时)
- 开发 postMessage 监听器
- 实现消息分发和路由
- 创建事件订阅/发布机制

### 2.4 连接管理 (2小时)
- 实现连接状态跟踪
- 添加重连和心跳机制
- 处理窗口关闭和页面卸载

## 🔧 技术要求

### 消息格式
```typescript
interface WidgetMessage {
  id: string;
  type: MessageType;
  payload: any;
  timestamp: number;
  source: 'widget' | 'parent';
}

enum MessageType {
  HANDSHAKE = 'handshake',
  AUTH_TOKEN = 'auth_token',
  CRM_DATA = 'crm_data',
  WIDGET_READY = 'widget_ready',
  ERROR = 'error',
  PING = 'ping',
  PONG = 'pong'
}
```

### 核心组件
```typescript
class MessageBridge {
  private targetWindow: Window;
  private allowedOrigins: string[];
  private messageQueue: WidgetMessage[] = [];

  // 发送消息
  sendMessage(type: MessageType, payload: any): void;

  // 处理接收的消息
  handleMessage(event: MessageEvent): void;

  // 验证消息来源
  private validateOrigin(origin: string): boolean;

  // 建立连接
  establishConnection(): Promise<void>;
}
```

### 安全措施
- 来源白名单验证
- 消息内容验证和清理
- 速率限制和防抖机制
- 错误边界和异常捕获

## ✅ 测试要求

- [x] 跨域消息发送和接收正常
- [x] 消息验证机制有效
- [x] 恶意消息被正确拦截
- [x] 连接状态管理准确
- [x] 错误处理和恢复机制

## 🚀 交付物

- [x] MessageBridge 核心通信类
- [x] 消息类型定义和接口
- [x] 验证和安全机制
- [x] 连接管理系统
- [x] 使用示例和文档

## 📚 参考资料

- [MDN postMessage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [Cross-origin communication security](https://web.dev/cross-origin-communication/)
- [Message passing in iframe](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [Window: message event](https://developer.mozilla.org/en-US/docs/Web/API/Window/message_event)